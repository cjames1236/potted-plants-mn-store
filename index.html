import React, { useEffect, useMemo, useState } from "react";
import { ShoppingCart, Leaf, ShieldCheck, FlaskConical, Truck, AlertTriangle, Minus, Plus, X, CheckCircle2, ExternalLink, Info } from "lucide-react";

/**
 * Hemp Gummies Store â€” Minnesota Compliant
 *
 * Adjusted for MN law:
 * - Max 5mg THC per serving, 50mg per package.
 * - Only Î”8/Î”9 THC allowed.
 * - Age gate (21+).
 * - Packaging: CR, tamper-evident, opaque.
 * - Labels: THC per serving, total THC, ingredients, allergens, batch #, warnings.
 * - COA QR/link embedded (Legend Technical).
 */

interface Product {
  id: string;
  name: string;
  description: string;
  price: number;
  image: string;
  strengthMg: number; // mg THC per gummy
  packSize: number;   // gummies per pack
  totalTHCmg: number; // mg THC per package
  flavors: string[];
  coaUrl: string;
  paymentLink?: string;
  inStock?: boolean;
  batchNumber: string;
}

interface CartItem { productId: string; qty: number; flavor?: string }

const BRAND = {
  name: "Potted Plants",
  tagline: "Minnesotaâ€‘compliant hempâ€‘derived gummies.",
  logoEmoji: "ðŸŒ¿",
};
// Place your uploaded logo file at /public/assets/potted-plants-logo.png (or update this path)
const LOGO_URL = "https://1drv.ms/u/c/dc5c1fb05bd2de17/ERfe0luwH1wggNw_BAAAAAABQFRJkCUJyzde2tvl8vDi_A?e=Hap32m";
// Cash App pay link (customer will enter amount + order note)
const CASH_APP_URL = "https://cash.app/$CurtisGieseke";

// Example product (from Legend Technical COA: 2.2mg THC per gummy, compliant)
const PRODUCTS: Product[] = [
  {
    id: "mn-thc-gummies-10pk",
    name: "Hempâ€‘Derived Î”9 Gummies",
    description: "Each gummy contains 2.2mg Î”9â€‘THC. 10 gummies per pack (22mg total THC). Compliant with MN law (â‰¤5mg per serving, â‰¤50mg per package). Thirdâ€‘party tested by Legend Technical Services, St Paul, MN.",
    price: 24.99,
    image: "https://placehold.co/600x400/png?text=Hemp+Î”9+Gummies+2.2mg+10pk",
    strengthMg: 2.2,
    packSize: 10,
    totalTHCmg: 22,
    flavors: ["Strawberry", "Blue Razz"],
    coaUrl: "https://1drv.ms/b/c/dc5c1fb05bd2de17/ERfe0luwH1wggNytEAAAAAABBc6xNatFTT68cmIluAhg9A?e=HJCaQQ", // replace with hosted PDF link
    paymentLink: "https://buy.stripe.com/test_XXXXXXXXXXXXXXXX", // replace with Stripe Payment Link
    inStock: true,
    batchNumber: "2400824-01",
  }
];

const usd = (n: number) => n.toLocaleString("en-US", { style: "currency", currency: "USD" });

export default function HempGummiesShop() {
  const [ageVerified, setAgeVerified] = useState(false);
  const [cartOpen, setCartOpen] = useState(false);
  const [cart, setCart] = useState<CartItem[]>([]);
  const [selectedState, setSelectedState] = useState<string>("");
  const [showCOAFor, setShowCOAFor] = useState<Product | null>(null);
  // State list for shipping gate
  const US_STATES: [string, string][] = [["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],["CO","Colorado"],["CT","Connecticut"],["DE","Delaware"],["FL","Florida"],["GA","Georgia"],["HI","Hawaii"],["ID","Idaho"],["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],["KS","Kansas"],["KY","Kentucky"],["LA","Louisiana"],["ME","Maine"],["MD","Maryland"],["MA","Massachusetts"],["MI","Michigan"],["MN","Minnesota"],["MS","Mississippi"],["MO","Missouri"],["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],["NH","New Hampshire"],["NJ","New Jersey"],["NM","New Mexico"],["NY","New York"],["NC","North Carolina"],["ND","North Dakota"],["OH","Ohio"],["OK","Oklahoma"],["OR","Oregon"],["PA","Pennsylvania"],["RI","Rhode Island"],["SC","South Carolina"],["SD","South Dakota"],["TN","Tennessee"],["TX","Texas"],["UT","Utah"],["VT","Vermont"],["VA","Virginia"],["WA","Washington"],["WV","West Virginia"],["WI","Wisconsin"],["WY","Wyoming"],["DC","District of Columbia"]];

  useEffect(() => {
    const ok = localStorage.getItem("hemp_age_verified");
    if (ok === "true") setAgeVerified(true);
  }, []);

  const cartTotal = cart.reduce((sum, item) => {
    const p = PRODUCTS.find(p => p.id === item.productId);
    return sum + (p ? p.price * item.qty : 0);
  }, 0);
  // MN-only shipping gate: if selected state is not MN, disable checkout
  const restricted = useMemo(() => selectedState !== "" && selectedState !== "MN", [selectedState]);

  function addToCart(product: Product, flavor?: string) {
    if (!product.inStock) return;
    setCartOpen(true);
    setCart(prev => {
      const i = prev.findIndex(x => x.productId === product.id && x.flavor === flavor);
      if (i >= 0) {
        const copy = [...prev];
        copy[i] = { ...copy[i], qty: copy[i].qty + 1 };
        return copy;
      }
      return [...prev, { productId: product.id, qty: 1, flavor }];
    });
  }

  function verifyAge() {
    setAgeVerified(true);
    localStorage.setItem("hemp_age_verified", "true");
  }
  // --- Cash App checkout helper (copies order note + opens Cash App) ---
  function cashAppCheckout(product: Product, qty: number) {
    if (selectedState !== "MN") {
      setCartOpen(true);
      alert("We ship within Minnesota only. Select MN to proceed.");
      return;
    }
    const orderId = "PK-" + Math.random().toString(36).slice(2, 8).toUpperCase();
    const total = product.price * qty;
    const note = `Order ${orderId} â€” ${product.name} x ${qty} @ ${usd(product.price)} â€” Total ${usd(total)} â€” Ship: MN`;
    try { navigator.clipboard?.writeText(note); } catch {}
    alert(`Copy this into your Cash App note before paying:

${note}`);
    window.open(CASH_APP_URL, "_blank");
  }

  // Anchor click handler for Cash App button in product card
  function handleCashAppCheckout(e: React.MouseEvent<HTMLAnchorElement>, product: Product) {
    e.preventDefault();
    const inCart = cart.find(i => i.productId === product.id)?.qty || 1;
    cashAppCheckout(product, inCart);
  }

  // --- Smart buy links (?buy=...&qty=...&state=MN&open=cart&checkout=cashapp) ---
  useEffect(() => {
    try {
      const qs = new URLSearchParams(window.location.search);
      const buy = qs.get("buy");
      if (!buy) return;
      const product = PRODUCTS.find(p => p.id === buy);
      if (!product) return;
      const qty = Math.max(1, parseInt(qs.get("qty") || "1", 10));
      const desiredState = qs.get("state");
      const open = qs.get("open");
      const checkout = qs.get("checkout"); // 'cashapp' | 'stripe'

      if (desiredState) setSelectedState(desiredState);

      // add to cart (merge if present)
      setCart(prev => {
        const i = prev.findIndex(x => x.productId === product.id);
        if (i >= 0) { const copy = [...prev]; copy[i] = { ...copy[i], qty: copy[i].qty + qty }; return copy; }
        return [...prev, { productId: product.id, qty }];
      });

      if (open === "cart") setCartOpen(true);

      if (checkout === "cashapp") {
        if (desiredState === "MN") cashAppCheckout(product, qty);
        else setCartOpen(true);
      }
      if (checkout === "stripe" && product.paymentLink) {
        if (desiredState === "MN") window.open(product.paymentLink, "_blank");
        else setCartOpen(true);
      }
    } catch { /* ignore */ }
  }, []);

  return (
    <div className="min-h-screen bg-neutral-50 text-neutral-900">
      {/* Nav */}
      <nav className="sticky top-0 bg-white border-b">
        <div className="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3 font-semibold text-lg">
            <img src={LOGO_URL} alt="Potted Plants logo" className="h-8 w-8 rounded-sm object-contain" />
            <span className="text-green-700">{BRAND.name}</span>
          </div>
          <button onClick={() => setCartOpen(true)} className="relative rounded-xl border px-3 py-2 text-sm flex items-center gap-2 hover:bg-neutral-50">
            <ShoppingCart className="h-4 w-4" />
            Cart ({cart.length})
          </button>
        </div>
      </nav>

      {/* Hero */}
      <header className="bg-gradient-to-br from-green-50 via-white to-amber-50">
        <div className="mx-auto max-w-6xl px-4 py-16">
          <h1 className="text-3xl font-bold text-green-800">Minnesotaâ€‘Compliant Hemp Gummies</h1>
          <p className="mt-3 text-neutral-700 max-w-prose">{BRAND.tagline} COA tested by Legend Technical Services, ISO/IEC 17025 accredited lab in St Paul, MN.</p>
        </div>
      </header>

      {/* Compliance & Shipping (MN only) */}
      <section id="policy" className="mx-auto max-w-6xl px-4 py-6">
        <div className="rounded-3xl border bg-white p-4 md:p-6 flex flex-col md:flex-row items-start md:items-center gap-4">
          <div className="flex-1">
            <h3 className="font-semibold">Shipping, Age & Compliance â€” Minnesota</h3>
            <ul className="text-sm text-neutral-700 list-disc pl-5 space-y-1">
              <li>21+ only; valid ID required.</li>
              <li>â‰¤ 5 mg THC per serving; â‰¤ 50 mg per package.</li>
              <li>Childâ€‘resistant, tamperâ€‘evident, opaque packaging; keep out of reach of children.</li>
            </ul>
          </div>
          <div className="flex items-center gap-2 w-full md:w-auto">
            <label htmlFor="state" className="text-sm text-neutral-700">Ship to:</label>
            <select id="state" className="w-full md:w-56 rounded-xl border px-3 py-2 text-sm" value={selectedState} onChange={e => setSelectedState(e.target.value)}>
              <option value="">Select stateâ€¦</option>
              {US_STATES.map(s => (
                <option key={s[0]} value={s[0]}>{s[1]}</option>
              ))}
            </select>
          </div>
          {selectedState && restricted && (
            <div className="text-amber-700 text-sm inline-flex items-center gap-2"><AlertTriangle className="h-4 w-4"/> We currently ship only within Minnesota.</div>
          )}
          {selectedState === "MN" && (
            <div className="text-green-700 text-sm inline-flex items-center gap-2"><ShieldCheck className="h-4 w-4"/> Minnesota shipping available.</div>
          )}
        </div>
      </section>

      {/* Products */}
      <section id="products" className="mx-auto max-w-6xl px-4 py-8">
        <h2 className="text-2xl font-bold mb-6">Shop</h2>
        <div className="grid sm:grid-cols-2 gap-6">
          {PRODUCTS.map(p => (
            <article key={p.id} className="rounded-3xl border bg-white shadow-sm p-5">
              <img src={p.image} alt={p.name} className="rounded-2xl mb-4"/>
              <h3 className="font-semibold text-lg">{p.name}</h3>
              <p className="text-sm text-neutral-600">{p.description}</p>
              <p className="mt-2 text-sm"><strong>{p.strengthMg}mg Î”9â€‘THC per gummy</strong> Ã— {p.packSize} gummies = {p.totalTHCmg}mg total</p>
              <p className="text-sm">Batch #: {p.batchNumber}</p>
              <p className="font-semibold mt-2">{usd(p.price)}</p>
              <div className="mt-4 flex flex-wrap gap-2 items-center">
                <a href={CASH_APP_URL}$1 onClick={(e)=>handleCashAppCheckout(e,p)}>Pay with Cash App</a>
                <button onClick={() => addToCart(p)} disabled={restricted || !p.inStock} className={`rounded-2xl px-4 py-2 text-white text-sm ${restricted || !p.inStock ? 'bg-neutral-300 cursor-not-allowed' : 'bg-green-700 hover:bg-green-800'}`}>Add to Cart</button>
                <a href={p.paymentLink} target="_blank" rel="noreferrer" className={`rounded-2xl border px-4 py-2 text-sm ${restricted ? 'pointer-events-none opacity-50' : 'hover:bg-neutral-50'}`}>Buy Now (Stripe)</a>
                {restricted && <span className="text-xs text-amber-700">Select Minnesota to enable checkout.</span>}
              </div>
              <div className="mt-3">
                <button onClick={() => setShowCOAFor(p)} className="underline text-sm">View COA (Legend Technical)</button>
              </div>
            </article>
          ))}
        </div>
      </section>

      {/* Footer with Compliance Notices */}
      <footer className="border-t bg-white">
        <div className="mx-auto max-w-6xl px-4 py-8 text-sm space-y-3">
          <p><strong>Compliance:</strong> â‰¤5mg THC per serving, â‰¤50mg per package, CR & tamperâ€‘evident opaque packaging, MN law compliant.</p>
          <p><strong>Warning:</strong> Keep this product out of the reach of children. For adult use only (21+). Not evaluated by the FDA. No health or medical claims.</p>
          <p>Â© {new Date().getFullYear()} {BRAND.name}, Savage MN.</p>
        </div>
      </footer>

      {/* COA Modal */}
      {showCOAFor && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
          <div className="w-full max-w-lg bg-white rounded-2xl p-6">
            <div className="flex items-center justify-between">
              <h4 className="font-semibold">Certificate of Analysis</h4>
              <button onClick={() => setShowCOAFor(null)}><X className="h-4 w-4"/></button>
            </div>
            <p className="text-sm mt-2">Batch {showCOAFor.batchNumber} tested by Legend Technical Services, St Paul, MN. ISO/IEC 17025 accredited.</p>
            <a href={showCOAFor.coaUrl} target="_blank" rel="noreferrer" className="inline-flex items-center gap-2 mt-4 border rounded-xl px-4 py-2 text-sm">Open COA PDF <ExternalLink className="h-4 w-4"/></a>
          </div>
        </div>
      )}

      {/* Age Gate */}
      {!ageVerified && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-white rounded-3xl p-6 text-center space-y-4">
            <h4 className="text-xl font-bold">Are you 21 or older?</h4>
            <p className="text-sm">You must be of legal age to enter this site and purchase hempâ€‘derived products.</p>
            <div className="grid grid-cols-2 gap-3">
              <button className="rounded-2xl border px-4 py-3 text-sm" onClick={() => (window.location.href = "https://www.google.com")}>No</button>
              <button className="rounded-2xl bg-emerald-600 px-4 py-3 text-sm text-white" onClick={verifyAge}>Yes, I am 21+</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
